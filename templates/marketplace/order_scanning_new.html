{% extends 'base.html' %}

{% block title %}Escaneo de Órdenes{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2>Escáner de Órdenes</h2>
                </div>
                <div class="card-body">
                    {% if scan_message %}
                    <div class="alert alert-{{ scan_status|default:'info' }}">
                        {{ scan_message }}
                    </div>
                    {% endif %}
                    
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="row g-3 align-items-end">
                            {% if order_data %}
                            <input type="hidden" name="order_id" value="{{ order_data.order.order_id }}">
                            <div class="col-md-8">
                                <label for="scanned_code" class="form-label">Escanear Producto:</label>
                                <input type="text" id="scanned_code" name="scanned_code" class="form-control form-control-lg" 
                                    placeholder="Escanea código de barras o SKU" autofocus>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Escanear</button>
                            </div>
                            {% else %}
                            <div class="col-md-8">
                                <label for="scanned_code" class="form-label">Escanear Orden:</label>
                                <input type="text" id="scanned_code" name="scanned_code" class="form-control form-control-lg" 
                                    placeholder="Escanea número de orden" autofocus>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary btn-lg w-100">Buscar Orden</button>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                    
                    {% if order_data %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">Detalles de la Orden</h4>
                                    <span class="badge bg-{{ order_data.marketplace|lower }}-light text-dark">{{ order_data.marketplace|upper }}</span>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Número de Orden:</strong> 
                                                {% if order_data.marketplace == 'paris' %}
                                                {{ order_data.order.originOrderNumber }} / {{ order_data.order.subOrderNumber }}
                                                {% else %}
                                                {{ order_data.order.order_id }}
                                                {% endif %}
                                            </p>
                                            <p><strong>Fecha:</strong> 
                                                {% if order_data.marketplace == 'paris' %}
                                                {{ order_data.order.createdAt }}
                                                {% else %}
                                                {{ order_data.order.created_date }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Cliente:</strong> 
                                                {% if order_data.marketplace == 'paris' %}
                                                {{ order_data.order.full_name }}
                                                {% else %}
                                                {{ order_data.order.full_name }}
                                                {% endif %}
                                            </p>
                                            <p><strong>Total:</strong> 
                                                ${% if order_data.marketplace == 'paris' %}
                                                {{ order_data.order.products_total }}
                                                {% else %}
                                                {{ order_data.order.total_price }}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-success text-white">
                                    <h4 class="mb-0">Productos Escaneados</h4>
                                </div>
                                <div class="card-body">
                                    {% if scanned_items %}
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Producto</th>
                                                    <th>Hora</th>
                                                    <th>BSale</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in scanned_items %}
                                                <tr>
                                                    <td>{{ item.code }}</td>
                                                    <td>{{ item.name }}</td>
                                                    <td>{{ item.time }}</td>
                                                    <td>
                                                        {% if item.bsale_info %}
                                                        <a href="#" class="btn btn-sm btn-info" data-bs-toggle="tooltip" 
                                                           title="Ver información de BSale" 
                                                           onclick="showBsaleInfo('{{ item.bsale_info|safe }}')">
                                                            <i class="bi bi-info-circle"></i>
                                                        </a>
                                                        {% else %}
                                                        <span class="badge bg-warning">No vinculado</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">
                                        Aún no se han escaneado productos.
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-secondary text-white">
                                    <h4 class="mb-0">Productos Pendientes</h4>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>SKU</th>
                                                    <th>Producto</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in order_data.items %}
                                                <tr class="{% if item.scanned %}table-success{% endif %}">
                                                    <td>{{ item.sku }}</td>
                                                    <td>
                                                        {% if order_data.marketplace == 'paris' %}
                                                        {{ item.name }}
                                                        {% else %}
                                                        {{ item.product_name }}
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.scanned %}
                                                        <span class="badge bg-success">Escaneado</span>
                                                        {% else %}
                                                        <span class="badge bg-warning">Pendiente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" onclick="showProductInfo({{ forloop.counter0 }})">
                                                            <i class="bi bi-info-circle"></i> Info
                                                        </button>
                                                        
                                                        {% if item.bsale_variant_id %}
                                                        <a href="{% url 'product_detail' order_data.marketplace item.bsale_variant_id %}" 
                                                           class="btn btn-sm btn-primary" target="_blank">
                                                            <i class="bi bi-box-arrow-up-right"></i> Detalle
                                                        </a>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{% url 'home' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir el modal de información de producto -->
{% include 'marketplace/order_scanning_item_info.html' %}

<!-- Modal para información de BSale -->
<div class="modal fade" id="bsaleInfoModal" tabindex="-1" aria-labelledby="bsaleInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="bsaleInfoModalLabel">Información de BSale</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table">
          <tr>
            <th>Código de Barras:</th>
            <td id="bsale-barcode"></td>
          </tr>
          <tr>
            <th>Código:</th>
            <td id="bsale-code"></td>
          </tr>
          <tr>
            <th>Producto:</th>
            <td id="bsale-product"></td>
          </tr>
          <tr>
            <th>ID:</th>
            <td id="bsale-id"></td>
          </tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a id="bsale-detail-link" href="#" class="btn btn-primary">Ver Detalle</a>
      </div>
    </div>
  </div>
</div>

<script>
// Script para autofocus del campo de escaneo
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('scanned_code').focus();
});

// Función para mostrar información de BSale
function showBsaleInfo(bsaleInfoJson) {
    try {
        const bsaleInfo = JSON.parse(bsaleInfoJson.replace(/'/g, '"'));
        document.getElementById('bsale-barcode').textContent = bsaleInfo.barcode || 'No disponible';
        document.getElementById('bsale-code').textContent = bsaleInfo.code || 'No disponible';
        document.getElementById('bsale-product').textContent = bsaleInfo.product_name || 'No disponible';
        document.getElementById('bsale-id').textContent = bsaleInfo.product_id || 'No disponible';
        
        // Configurar enlace de detalle
        if (bsaleInfo.product_id) {
            document.getElementById('bsale-detail-link').href = `/marketplace/product/{{ order_data.marketplace }}/${bsaleInfo.product_id}/`;
            document.getElementById('bsale-detail-link').classList.remove('disabled');
        } else {
            document.getElementById('bsale-detail-link').href = '#';
            document.getElementById('bsale-detail-link').classList.add('disabled');
        }
        
        // Mostrar el modal
        new bootstrap.Modal(document.getElementById('bsaleInfoModal')).show();
    } catch (e) {
        console.error('Error parsing BSale info:', e);
    }
}
</script>
{% endblock %}